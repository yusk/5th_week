/************************************************************************************
* Implements data primitives 
*
* (c) Copyright 2007, Freescale, Inc.  All rights reserved.
*
* No part of this document must be reproduced in any form - including copied,
* transcribed, printed or by any electronic means - without specific written
* permission from Freescale Semiconductor.
*
************************************************************************************/

#include "MacPhyGlobalHdr.h"
#include "Phy.h"
#include "PhyMacMsg.h"

/************************************************************************************
*************************************************************************************
* Private macros
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Private prototypes
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Private type definitions
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Public memory declarations
*************************************************************************************
************************************************************************************/
uint8_t mPhyLastRxLQI;

/************************************************************************************
*************************************************************************************
* Private memory declarations
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Public functions
*************************************************************************************
************************************************************************************/
/* Place it in NON_BANKED memory */
#ifdef MEMORY_MODEL_BANKED
#pragma CODE_SEG __NEAR_SEG NON_BANKED
#else
#pragma CODE_SEG DEFAULT
#endif /* MEMORY_MODEL_BANKED */
/************************************************************************************
* Get and convert Link Quality
*
* Abel returns values between -95 dBm to about -18 dBm which are represented by decimal
* values 190 (0xbe) and 36 (0x24) respectively.
*
************************************************************************************/
void ConvertLinkQuality(void){
  uint8_t     linkQuality = gpPhyRxData->linkQuality;
#ifndef gLQIMappingForRF4CE_c
  // Recalculate the link quality to conform with other link quality measures
  // Make dynamics of the energy level vary from 0x00-0xff
  if (linkQuality > 190) {
    linkQuality = 190; //190 = -95dBm as floor (translates to 0x00)
  }
  if (linkQuality < 33) {
    linkQuality = 33; //33 = -16.5 dBm as top (saturation)
  }
  linkQuality = 190 - linkQuality;
  linkQuality = linkQuality + (linkQuality >> 1) + (linkQuality >> 3); // equivalent with multiply by 1.625
#else // gLQIMappingForRF4CE_c
  linkQuality = 255 - linkQuality;
#endif // gLQIMappingForRF4CE_c
  gpPhyRxData->linkQuality = linkQuality;
  mPhyLastRxLQI = linkQuality;
}



/************************************************************************************
* Initiates data transmission
* 
*
* Interface assumptions:
*
* Return value:
*   NONE
*
************************************************************************************/

void PhyPdDataRequest(txPacket_t *pTxPacket)
{
  uint16_t tmpData;
  // Assert if not in tx state
  PhyAssert(mPhyTxRxState==cBusy_Tx);

  // Get Tx buffer from MAC
  gpPhyTxPacket = pTxPacket->txData;

  // Write Length to Abel
  MC1319xDrv_WriteSpiSync(TX_CONTROL, pTxPacket->frameLength);

  // Initialize remaining length counter to length minus (2+2) (2 CRC and the 2 first bytes copied here) 
  gTxRemainingLength = (uint8_t) pTxPacket->frameLength - 4;

  // Init Data Tx Buffer Index to 2 because 2 first bytes copied here 
  gPhyMacDataTxIndex=2;

  // Copy data from data buffer to Abel (Reverse Endianess)
  tmpData = ((gpPhyTxPacket[1] << 8) | (gpPhyTxPacket[0] & 0x7F) );     /*  ensure that reserved bit is cleared  */
  MC1319xDrv_WriteSpiSync(TX_DATA, tmpData);
}

uint8_t PhyGetLastRxLqiValue(void)
{
  return mPhyLastRxLQI;
}

#pragma CODE_SEG DEFAULT
/************************************************************************************
*************************************************************************************
* Private functions
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Module debug stuff
*************************************************************************************
************************************************************************************/




/************************************************************************************
*************************************************************************************
* Level 1 block comment
*************************************************************************************
************************************************************************************/

//-----------------------------------------------------------------------------------
//-----------------------------------------------------------------------------------
// Level 2 block comment
//-----------------------------------------------------------------------------------
//-----------------------------------------------------------------------------------

/* Level 3 block comment */




// Delimiters

/***********************************************************************************/

//-----------------------------------------------------------------------------------
